# 微信公众号开发

约定：  
微信公众平台文档中的开发者一般指的是微信公众号的用户服务器。
"用户点击自定义菜单后，微信会把点击事件推送给开发者"，这里是说微信会把点击事件
通过【开发】-> 【基本配置】->【服务器配置】-> 【服务器地址URL】发送到用户服务器。

## <font color="blue">准备工作</font>

详见[入门开发指引](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1472017492_58YV5)

1. 申请微信公众号或者测试号并配置；
2. 搭建具有公网IP的后台服务器或者使用内网穿透服务连接开发机器；
3. 通过签名校验。

#### 微信公众号开发基础

+ OpenID / UnionID

    每个微信用户在每个公众号内的一个唯一的安全的身份标识。
    
    多个微信公众号或移动应用中使用相同的用户标示可以将这些公众号或应用绑定到一个开放平台账号下。
    然后每一个用户会有一个UnionID，用于此开放平台下所有公众号和应用。
    
    同一个微信开放平台（多个公众号）下每个用户的 UnionID 唯一，OpenID 则在每个公众号下唯一，在多个公众号可能相同。
    在包含多个公众号的开放平台下面的某个公众号中使用 OpenID 是没有问题的，只要不去其他公众号串门的话。
    
+ 微信公众号使用限制

    - 接口调用频次限制
    
+ 接口调试工具 / 接口报警
     
+ 接口调用 与 返回码
    
    - access_token(接口调用凭据)
        注意每个access_token，2小时内有效，重新获取次数有限制。
    - 公众平台接口调用只支持80端口
    
    - [返回码](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1433747234)
    
+ 微信公众号能力

    - 消息会话
        * 群发消息（主动，订阅号1天1次）
        * 被动回复消息（被动，涉及消息加解密）
        * 客服消息
        * 模板消息（主动）
    - 微信事件与消息推送
    - 公众号内网页
        * 网页授权获取用户基本信息
        * 微信JS-SDK，提供网页开发能力（录制和播放微信语音、监听微信分享、上传手机本地图片、拍照等）

+ 开发者规范（主要是用户数据保护）

+ 公众号接口权限（拥有哪些接口使用权限）

+ [入门开发指引](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1472017492_58YV5)
    
    讲解环境搭建，基础功能开发Demo

## <font color="blue"> 功能开发 </font>

### 1 必备功能

#### 1.1 微信公众号接入后台服务

![接入签名校验流程](http://mmbiz.qpic.cn/mmbiz_png/PiajxSqBRaEIQxibpLbyuSK9B2CRwJYwMRFbDwdwNicNwcwhWaTuibPIqUwocStP6VicjxyGc2S96XlaNiciagkc26eKg/0?wx_fmt=png)

微信认证：需要企业群体才能认证。
开发阶段可以先用测试号开发，拥有访问所有接口的权限。

##### 获取access_token

access_token是公众号的全局唯一接口调用凭据，有效期2小时，需定时刷新重新获取，每天获取次数有限。
在刷新过程中5分钟内老 access_token 仍旧可用。
access_token的有效时间可能会在未来有调整，所以中控服务器不仅需要内部定时主动刷新，还需要提供被动刷新access_token的接口，
这样便于业务服务器在API调用获知access_token已超时的情况下，可以触发access_token的刷新流程。

##### 报警排查

用于快速发现和定位问题，当公众号平台向开发者后台服务器推送消息失败次数达到预定阈值，
报警消息会发送到接口告警页面

##### 获取微信服务器IP地址列表（安全考虑）
```
GET https://api.weixin.qq.com/cgi-bin/getcallbackip?access_token=ACCESS_TOKEN
```

##### 网络检测


#### 1.2 自定义菜单

通过接口请求创建菜单，查询菜单，删除菜单
```
POST    https://api.weixin.qq.com/cgi-bin/menu/create?access_token=ACCESS_TOKEN
GET     https://api.weixin.qq.com/cgi-bin/menu/get?access_token=ACCESS_TOKEN
GET     https://api.weixin.qq.com/cgi-bin/menu/get?access_token=ACCESS_TOKEN
```

自定义菜单事件推送，共有9种事件推送(请求内容数据是xml格式)：
```
1 点击菜单拉取消息时的事件推送

2 点击菜单跳转链接时的事件推送

3 scancode_push：扫码推事件的事件推送

4 scancode_waitmsg：扫码推事件且弹出“消息接收中”提示框的事件推送

5 pic_sysphoto：弹出系统拍照发图的事件推送

6 pic_photo_or_album：弹出拍照或者相册发图的事件推送

7 pic_weixin：弹出微信相册发图器的事件推送

8 location_select：弹出地理位置选择器的事件推送

9 点击菜单跳转小程序的事件推送
```

已认证的公众号可以访问个性化菜单接口


#### 1.3 消息管理

##### 接收普通消息

公众号关注者向公众号发送消息，公众号平台以POST方式将XML数据包发送到开发者服务器。

+ 文本消息

+ 图片消息

+ 语音消息

+ 视频消息

+ 小视频消息

+ 地理位置消息

+ 链接消息

##### 接收事件推送

用户操作通过微信服务器以事件推送的方式发送到开发者服务器。

+ 关注/取消关注事件

+ 扫描带参数二维码事件

+ 上报地址位置事件

+ 自定义菜单事件

+ 点击菜单拉取消息时的事件推送

+ 点击菜单跳转链接时的事件推送

##### 被动回复用户消息

##### 消息加解密说明

#### 1.4 素材管理

#### 1.5 图文消息留言

#### 1.6 用户管理

+ 生成带参数的二维码

    关于二维码的生成原理：[二维码的生成细节和原理](https://www.cnblogs.com/alantu2018/p/8504373.html)

    1）创建二维码ticket
    2）凭借ticket到指定URL换取二维码

#### 1.7 账号管理

#### 1.8 数据统计

#### 1.9 智能接口（功能比较通用）

#### 1.10 客服功能

### 2 页面开发

#### 2.1 微信网页开发

### 3 其他功能

#### 3.1 微信卡券

#### 3.2 微信门店

#### 3.3 微信小店

#### 3.4 外接设备

#### 3.5 微信摇一摇（其他功能的快捷方式）

#### 3.6 微信连WIFI

#### 3.7 微信一物一码

#### 3.8 微信发票

#### 3.9 微信非税缴费

#### 3.10 微信支付
